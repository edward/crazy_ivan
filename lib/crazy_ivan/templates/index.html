<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>Crazy Ivan: CI straight up.</title>
  
    <link rel="stylesheet" href="css/ci.css" type="text/css" charset="utf-8">
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
    <script type="text/javascript">
      // Simple JavaScript Templating
      // John Resig - http://ejohn.org/ - MIT Licensed
      (function(){
        var cache = {};
 
        this.tmpl = function tmpl(str, data){
          // Figure out if we're getting a template, or if we need to
          // load the template - and be sure to cache the result.
          var fn = !/\W/.test(str) ?
            cache[str] = cache[str] ||
              tmpl(document.getElementById(str).innerHTML) :
     
            // Generate a reusable function that will serve as a template
            // generator (and which will be cached).
            new Function("obj",
              "var p=[],print=function(){p.push.apply(p,arguments);};" +
       
              // Introduce the data as local variables using with(){}
              "with(obj){p.push('" +
       
              // Convert the template into pure JavaScript
              str
                .replace(/[\r\t\n]/g, " ")
                .split("<%").join("\t")
                .replace(/((^|%>)[^\t]*)'/g, "$1\r")
                .replace(/\t=(.*?)%>/g, "',$1,'")
                .split("\t").join("');")
                .split("%>").join("p.push('")
                .split("\r").join("\\'")
            + "');}return p.join('');");
   
          // Provide some basic currying to the user
          return data ? fn( data ) : fn;
        };
      })();
    </script>
    <style type="text/css" media="screen">
      body {
        margin: 2.5em 3em;
        padding: 0;
        background: #fff;
        color: #333;
        font: 100%/1.5 "Helvetica Neue", Helvetica, Arial, sans-serif;
      }

      h1 { margin: 0;}

      pre { margin: 0;}

      .error {
        color: red;
      }

      .project h2 { margin: 12px 0 0 0;}

      .tests { margin: 0 0 0 18px;}
      .tests .test { font-size: 80%; margin-right: 8px;}
      .tests .latest { font-size: 100%;}

      .result .timestamp { margin-right: 12px;}
      .result .version { margin: 6px 0 6px 12px }
      .result .output { padding: 5px; color: silver; background:black; margin: 12px 18px 8px 18px; overflow: auto }
      .result .output .update { margin: 6px 0 6px 12px }
      .result .output .test { margin: 6px 0 6px 12px}

      .footer { 
        margin: 24px 0 0 0;
        font-size: 60%;
        width: 100%;
        text-align: center;
      }
      
      /** html { font-family: arial, sans-serif;}
          
            .project { margin: 10px; border: 1px solid #ddd; padding: 10px; background: #f0f0f0;}
          
            .build_report { border: 1px solid #333; padding: 10px; background: #222; color: #fff;}

            ul.builds { list-style:none; margin: 10px 0; padding: 0; }
            ul.builds li { list-style:none; display:inline; margin: 0; padding: 5px 10px; }
            ul.builds li { text-decoration: underline; cursor: pointer; color: blue; }
            ul.builds li.failed { color: red; }
            ul.builds li.active { background: #ffa; font-weight: bold; }        */
    </style>
  </head>
  <body>
    <h1>Projects</h1>
    <div id="projects"></div>
    
    <div class="footer">
      <a href="http://github.com/edward/crazy_ivan">Crazy Ivan on Github</a>
    </div>
  
    <!-- templates -->  
    
    <!-- project template -->
    <script type="text/html" id="project-template">
      <div id="<%= projectId %>" class="project">
        <h2><%= projectName %></h2>
        
        <div class='tests'></div>
        <div class='results'></div>
      <div>
    </script>
    
    <!-- test link template -->
    <script type="text/html" id="result-link-template">
      <a class="test <%= if(!test.exit_status) {'error'} %>"><%= timestamp.finish %></a>
    </script>
    
    <!-- build result holder -->
    <script type="text/html" id="result-template">
      <div id="result-<%= projectName %>-<%= version.output %>" class="result" style="display: none">
        <div>
          <span class='timestamp'><%= timestamp.finish %></span>
          <span class='version'><%= version.output %></span>
        </div>
        
        <div class='output' style="display: none">
          <div class='version'><pre class='error'><%= version.error %></pre></div>
        </div>
        
        <div class='update' style="display: none">
          <pre><%= update.output %></pre>
          <pre class='error'><%= update.error %></pre>
        </div>
        
        <div class='test'>
          <pre><%= test.output.replace(/\</g, "&lt;").replace(/\>/g, "&gt;") %></pre>
          <pre class='error'><%= test.error %></pre>
        </div>
      </div>
    </script>
    
    <!-- <div class="project">
      <h2>project name</h2>
      
      <div class='tests'>
        <a class='test {error if exit status}'>timestamp.finish</a>
      </div>
      
      <div class='results'>
        <div class='result' id='result-{name}-{version-number}'>
          <div>
            <span class='timestamp'>{timestamp.finish}</span>
            <span class='version'>{version.output}</span>
          </div>
          
          <div class='output'>
            <div class='version'><pre class='error'>{version.error}</pre></div>
          </div>
          
          <div class='update'>
            <pre>{update.output}</pre>
            <pre class='error'>{update.error}</pre>
          </div>
          
          <div class='test'>
            <pre>{test.output}</pre>
            <pre class='error'>{test.error}</pre>
          </div>
        </div>
      </div>
    </div> -->

  <script type="text/javascript" charset="utf-8">
    // load and build each project div
    var loadProject = function(projectName) {
      var recentVersionsJsonPath = projectName + "/recent.json";
      var domId = projectName.replace(/\./g, "");      // remove . from id name
        
      // create project holder div
      $('#projects').append( tmpl("project-template", {projectName: projectName, projectId: domId}));

      // // gets recent.json
      // jQuery.getJSON(recentVersionsJsonPath, function(data) {
      //   jQuery.each(data.recent_versions, function(i, version) {
      //     // // insert a li and get the build data for it
      //     //           $("#" + domId + " ul.builds").append( tmpl("link_template", { id : version }) ); 
      //     
      //     loadResult(projectName, version);  // create each build report
      //   });
      // });
    };

    // creates each build result
    var loadResult = function(projectName, version) {
      var resultJsonPath = projectName + "/" + version + ".json";
      var domId     = projectName.replace(/\./g, "");      // remove . from id name
    
      jQuery.getJSON(resultJsonPath, function(data) {
        data["project"] = projectName;
        
        // FIXME clean each output with test.output.replace(/\</g, "&lt;").replace(/\>/g, "&gt;")
        
        $("#" + domId + " .results").append(tmpl("result-template", data));
    
        // // get timestamp info and update build link
        // var timestamp = new Date(Date.parse(data.timestamp.finish));
        // var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        // var label = months[timestamp.getMonth()] + " " + timestamp.getDay() + " " + timestamp.getHours() + ":" + timestamp.getMinutes();
        // $("#" + version).html(label); // 12:45
      
        // Add result links
        // $('#' + ).append(tmpl("result-link-template", data));
        //       
        // // add failed/success class to link
        // if (data.test.exit_status) {
        //   $("#" + version).addClass('failed');
        // }
      });
    };

    jQuery(document).ready(function($){
      // load list of projects
      $.getJSON("projects.json", function(data) {
        jQuery.each(data.projects, function(){
          loadProject(this);
        });
      });
    
      // // listen to clicking of build links
      //       $('ul.builds li').live('click', function(e){
      //         var build = "#build_"+e.target.id; 
      //         $('.build_report:visible').hide(); // hide all visible reports
      //         $(build).show();                   // show selected one
      //       
      //         $('ul.builds li.active').removeClass('active');
      //         $(e.target).addClass('active');      
      //       });
    });
  </script>
  </body>
</html>