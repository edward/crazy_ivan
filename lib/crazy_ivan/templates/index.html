<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-type" content="text/html; charset=utf-8">
  <title>Crazy Ivan: CI straight up.</title>
  
  <link rel="stylesheet" href="css/ci.css" type="text/css" charset="utf-8">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
  <script type="text/javascript">
    // Simple JavaScript Templating
    // John Resig - http://ejohn.org/ - MIT Licensed
    (function(){
      var cache = {};
 
      this.tmpl = function tmpl(str, data){
        // Figure out if we're getting a template, or if we need to
        // load the template - and be sure to cache the result.
        var fn = !/\W/.test(str) ?
          cache[str] = cache[str] ||
            tmpl(document.getElementById(str).innerHTML) :
     
          // Generate a reusable function that will serve as a template
          // generator (and which will be cached).
          new Function("obj",
            "var p=[],print=function(){p.push.apply(p,arguments);};" +
       
            // Introduce the data as local variables using with(){}
            "with(obj){p.push('" +
       
            // Convert the template into pure JavaScript
            str
              .replace(/[\r\t\n]/g, " ")
              .split("<%").join("\t")
              .replace(/((^|%>)[^\t]*)'/g, "$1\r")
              .replace(/\t=(.*?)%>/g, "',$1,'")
              .split("\t").join("');")
              .split("%>").join("p.push('")
              .split("\r").join("\\'")
          + "');}return p.join('');");
   
        // Provide some basic currying to the user
        return data ? fn( data ) : fn;
      };
    })();
  </script>
  <style type="text/css" media="screen">
    * html { font-family: arial, sans-serif;}
    
    .project { margin: 10px; border: 1px solid #ddd; padding: 10px; background: #f0f0f0;}
    
    .build_report { border: 1px solid #333; padding: 10px; background: #222; color: #fff;}

    ul.builds { list-style:none; margin: 10px 0; padding: 0; }
    ul.builds li { list-style:none; display:inline; margin: 0; padding: 5px 10px; }
    ul.builds li { text-decoration: underline; cursor: pointer; color: blue; }
    ul.builds li.failed { color: red; }
    ul.builds li.active { background: #ffa; font-weight: bold; }        
  </style>
</head>
<body>
  <h1>Projects</h1>
  <div id="projects">
<!-- project results get inserted here -->
  </div>


  <div class="footer">
    <a href="http://github.com/edward/crazy_ivan">Crazy Ivan on Github</a>
  </div>
  
<!-- templates -->  

<!-- project holder template -->
<script type="text/html" id="project_template">
  <div id="<%= id %>" class="project">
    <h2><%= name %></h2>
    <ul class="builds"></ul>
    <div class="build-reports"></div>
  <div>
</script>

<!-- link_to_build template -->
<script type="text/html" id="link_template">
  <li id="<%= id %>">Link</li>
</script>

<!-- build holder -->
<script type="text/html" id="build_template">
  <div id="build_<%= version.output %>" class="build_report"  style="display:none">
    <p class="timestamp"><%= timestamp.finish %></p>
    <p class="version"><%= version.output %></p>
    <div class="output">
      <pre><%= test.output.replace(/\</g, "&lt;").replace(/\>/g, "&gt;") %></pre>
      <pre><%= test.error %></pre>
    </div>
  </div>
</script>



<script type="text/javascript" charset="utf-8">

  // load and build each project div
  var loadProject = function(project_name) {
    var json_file = project_name+"/recent.json";
    var domid     = project_name.replace(/\./g, "");      // remove . from id name
        
    // create project holder DIV
    $('#projects').append( tmpl("project_template", {name: project_name, id: domid}));

    // gets recent.json
    jQuery.getJSON(json_file, function(data){
      jQuery.each(data.recent_versions, function(i, build_id){
        $("#"+domid+" ul.builds").append( tmpl("link_template", { id : build_id }) ); // insert a li and get the build data for it
        loadBuild(project_name, build_id);  // create each build report
      });
    });
  };

  // creates each build report
  var loadBuild = function(project_name, build_id) {
    var json_file = project_name+"/"+build_id+".json";
    var domid     = project_name.replace(/\./g, "");      // remove . from id name
    
    jQuery.getJSON(json_file, function(data){
    
      $("#"+domid + " .build-reports").append( tmpl("build_template", data) );      
    
      // get timestamp info and update build link
      var timestamp = new Date(Date.parse(data.timestamp.finish));
      var months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
      var label = months[timestamp.getMonth()]+" "+timestamp.getDay()+" "+timestamp.getHours() + ":"+ timestamp.getMinutes();
      $("#"+build_id).html(label); // 12:45
      
      // add failed/success class to link
      if (data.test.exit_status) {
        $("#"+build_id).addClass('failed');        
      }
    });
  };


  jQuery(document).ready(function($){
    // load list of projects
    $.getJSON("projects.json", function(data) {
      jQuery.each(data.projects, function(){
        loadProject(this);
      });
    });
    
    // listen to clicking of build links
    $('ul.builds li').live('click', function(e){
      var build = "#build_"+e.target.id; 
      $('.build_report:visible').hide(); // hide all visible reports
      $(build).show();                   // show selected one
      
      $('ul.builds li.active').removeClass('active');
      $(e.target).addClass('active');      
    });
  });
</script>
</body>
</html>